Saya telah menganalisis struktur data yang ada di aplikasi ini. Sekarang saya akan membuat rencana lengkap untuk database schema dengan Row Level Security (RLS) policies untuk multi-tenant security.

# Database Schema untuk Produksi dengan Multi-Tenant RLS

## Ringkasan
Membuat database schema lengkap di Lovable Cloud dengan Row Level Security untuk memastikan isolasi data antar sekolah. Schema akan mengikuti struktur data yang sudah ada di `dummyData.ts`.

---

## Tahap 1: Enum dan Types

```sql
-- Jenjang sekolah
CREATE TYPE public.school_level AS ENUM ('SD', 'SMP', 'SMA', 'SMK');

-- Role pengguna (HARUS di tabel terpisah sesuai security requirements)
CREATE TYPE public.app_role AS ENUM ('super_admin', 'admin_sekolah', 'operator');

-- Status kepegawaian
CREATE TYPE public.employment_status AS ENUM ('PNS', 'PPPK', 'Honorer', 'Tetap Yayasan', 'Tidak Tetap Yayasan');

-- Jenis kelamin
CREATE TYPE public.gender_type AS ENUM ('L', 'P');

-- Status post
CREATE TYPE public.post_status AS ENUM ('draft', 'published');

-- Status pendaftaran
CREATE TYPE public.registration_status AS ENUM ('pending', 'approved', 'rejected');

-- Status siswa
CREATE TYPE public.student_status AS ENUM ('aktif', 'pindah', 'lulus', 'keluar');
```

---

## Tahap 2: Core Tables

### 2.1 Schools Table
```sql
CREATE TABLE public.schools (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  domain VARCHAR(255) UNIQUE NOT NULL,
  level school_level NOT NULL,
  logo TEXT,
  address TEXT,
  phone VARCHAR(50),
  email VARCHAR(100),
  theme_color VARCHAR(20) DEFAULT '#2563eb',
  hero_images TEXT[] DEFAULT '{}',
  profile_image TEXT,
  vision TEXT,
  mission TEXT[] DEFAULT '{}',
  about TEXT,
  is_active BOOLEAN DEFAULT true,
  founded_year INTEGER,
  accreditation VARCHAR(10),
  student_count INTEGER DEFAULT 0,
  npsn VARCHAR(20),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.2 Profiles Table (linked to auth.users)
```sql
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  school_id INTEGER REFERENCES public.schools(id) ON DELETE SET NULL,
  staff_id INTEGER,
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.3 User Roles Table (WAJIB terpisah untuk keamanan)
```sql
CREATE TABLE public.user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  role app_role NOT NULL,
  UNIQUE (user_id, role)
);
```

### 2.4 Staff Table
```sql
CREATE TABLE public.staff (
  id SERIAL PRIMARY KEY,
  school_id INTEGER REFERENCES public.schools(id) ON DELETE CASCADE NOT NULL,
  name VARCHAR(255) NOT NULL,
  position VARCHAR(100),
  class_or_subject VARCHAR(100),
  nip VARCHAR(30),
  nik VARCHAR(20),
  nuptk VARCHAR(30),
  phone VARCHAR(20),
  email VARCHAR(100),
  email_personal VARCHAR(100),
  address TEXT,
  photo_url TEXT,
  is_public BOOLEAN DEFAULT true,

  -- Data Kepegawaian
  employment_status employment_status,
  rank_grade VARCHAR(50),
  tmt_employment DATE,
  sk_number VARCHAR(50),

  -- Data Pribadi
  gender gender_type,
  birth_place VARCHAR(100),
  birth_date DATE,
  education_level VARCHAR(10),
  major VARCHAR(100),
  marriage_status VARCHAR(20),

  -- Data Tambahan
  npwp VARCHAR(30),
  taspen VARCHAR(30),
  bpjs_ketenagakerjaan VARCHAR(30),
  bpjs_kesehatan VARCHAR(30),

  -- Data Keluarga
  spouse_name VARCHAR(255),
  children_count INTEGER DEFAULT 0,
  father_name VARCHAR(255),
  mother_name VARCHAR(255),

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.5 Students Table
```sql
CREATE TABLE public.students (
  id SERIAL PRIMARY KEY,
  school_id INTEGER REFERENCES public.schools(id) ON DELETE CASCADE NOT NULL,
  name VARCHAR(255) NOT NULL,
  class VARCHAR(50),
  nis VARCHAR(20),
  nisn VARCHAR(20),
  gender gender_type,
  birth_place VARCHAR(100),
  birth_date DATE,
  religion VARCHAR(50),
  address TEXT,

  -- Data Orang Tua
  parent_name VARCHAR(255),
  parent_phone VARCHAR(20),
  father_name VARCHAR(255),
  father_occupation VARCHAR(100),
  mother_name VARCHAR(255),
  mother_occupation VARCHAR(100),
  guardian_name VARCHAR(255),
  guardian_phone VARCHAR(20),

  -- Data Akademik
  previous_school VARCHAR(255),
  entry_year VARCHAR(10),
  entry_semester VARCHAR(20),
  status student_status DEFAULT 'aktif',

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.6 Posts Table
```sql
CREATE TABLE public.posts (
  id SERIAL PRIMARY KEY,
  school_id INTEGER REFERENCES public.schools(id) ON DELETE CASCADE NOT NULL,
  author_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  title VARCHAR(500) NOT NULL,
  content TEXT,
  excerpt TEXT,
  image_url TEXT,
  category VARCHAR(50),
  status post_status DEFAULT 'draft',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.7 Gallery Table
```sql
CREATE TABLE public.gallery (
  id SERIAL PRIMARY KEY,
  school_id INTEGER REFERENCES public.schools(id) ON DELETE CASCADE NOT NULL,
  author_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  title VARCHAR(255) NOT NULL,
  image_url TEXT NOT NULL,
  category VARCHAR(50),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.8 School Registrations Table
```sql
CREATE TABLE public.school_registrations (
  id SERIAL PRIMARY KEY,
  school_name VARCHAR(255) NOT NULL,
  domain VARCHAR(255),
  level school_level,
  address TEXT,
  phone VARCHAR(50),
  email VARCHAR(100),
  contact_person VARCHAR(255),
  contact_phone VARCHAR(50),
  status registration_status DEFAULT 'pending',
  notes TEXT,
  registration_date TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## Tahap 3: Security Definer Functions

### 3.1 Function untuk cek role user
```sql
CREATE OR REPLACE FUNCTION public.has_role(_user_id UUID, _role app_role)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 FROM public.user_roles
    WHERE user_id = _user_id AND role = _role
  )
$$;
```

### 3.2 Function untuk mendapatkan school_id user
```sql
CREATE OR REPLACE FUNCTION public.get_user_school_id(_user_id UUID)
RETURNS INTEGER
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT school_id FROM public.profiles WHERE id = _user_id
$$;
```

### 3.3 Function untuk cek apakah user adalah Super Admin
```sql
CREATE OR REPLACE FUNCTION public.is_super_admin(_user_id UUID)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT public.has_role(_user_id, 'super_admin')
$$;
```

### 3.4 Function untuk cek akses ke sekolah tertentu
```sql
CREATE OR REPLACE FUNCTION public.can_access_school(_user_id UUID, _school_id INTEGER)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT 
    public.is_super_admin(_user_id) 
    OR public.get_user_school_id(_user_id) = _school_id
$$;
```

---

## Tahap 4: Row Level Security Policies

### 4.1 Enable RLS on All Tables
```sql
ALTER TABLE public.schools ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.staff ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.students ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.posts ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.gallery ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.school_registrations ENABLE ROW LEVEL SECURITY;
```

### 4.2 Schools Policies
```sql
-- Public: Bisa lihat sekolah aktif (untuk website publik)
CREATE POLICY "Public can view active schools"
  ON public.schools FOR SELECT
  USING (is_active = true);

-- Super Admin: Full access
CREATE POLICY "Super admin full access to schools"
  ON public.schools FOR ALL
  TO authenticated
  USING (public.is_super_admin(auth.uid()));

-- Admin Sekolah: Bisa edit sekolahnya sendiri
CREATE POLICY "School admin can update own school"
  ON public.schools FOR UPDATE
  TO authenticated
  USING (public.can_access_school(auth.uid(), id));
```

### 4.3 Profiles Policies
```sql
-- Users can view own profile
CREATE POLICY "Users can view own profile"
  ON public.profiles FOR SELECT
  TO authenticated
  USING (id = auth.uid());

-- Users can update own profile
CREATE POLICY "Users can update own profile"
  ON public.profiles FOR UPDATE
  TO authenticated
  USING (id = auth.uid());

-- Super admin can view all profiles
CREATE POLICY "Super admin can view all profiles"
  ON public.profiles FOR SELECT
  TO authenticated
  USING (public.is_super_admin(auth.uid()));

-- School admin can view profiles in their school
CREATE POLICY "School admin can view school profiles"
  ON public.profiles FOR SELECT
  TO authenticated
  USING (
    public.has_role(auth.uid(), 'admin_sekolah') 
    AND school_id = public.get_user_school_id(auth.uid())
  );
```

### 4.4 User Roles Policies
```sql
-- Super Admin: Full access ke user_roles
CREATE POLICY "Super admin full access to user_roles"
  ON public.user_roles FOR ALL
  TO authenticated
  USING (public.is_super_admin(auth.uid()));

-- Users can view own role
CREATE POLICY "Users can view own role"
  ON public.user_roles FOR SELECT
  TO authenticated
  USING (user_id = auth.uid());
```

### 4.5 Staff Policies
```sql
-- Public: Bisa lihat staff publik (untuk website)
CREATE POLICY "Public can view public staff"
  ON public.staff FOR SELECT
  USING (is_public = true);

-- School users: Full access ke staff sekolahnya
CREATE POLICY "School users can manage own school staff"
  ON public.staff FOR ALL
  TO authenticated
  USING (public.can_access_school(auth.uid(), school_id));
```

### 4.6 Students Policies
```sql
-- School users: Full access ke siswa sekolahnya
CREATE POLICY "School users can manage own school students"
  ON public.students FOR ALL
  TO authenticated
  USING (public.can_access_school(auth.uid(), school_id));
```

### 4.7 Posts Policies
```sql
-- Public: Bisa lihat post yang published
CREATE POLICY "Public can view published posts"
  ON public.posts FOR SELECT
  USING (status = 'published');

-- Authenticated users: Bisa lihat semua post di sekolahnya
CREATE POLICY "School users can view all school posts"
  ON public.posts FOR SELECT
  TO authenticated
  USING (public.can_access_school(auth.uid(), school_id));

-- Admin/Super Admin: Full CRUD
CREATE POLICY "Admins can manage school posts"
  ON public.posts FOR ALL
  TO authenticated
  USING (
    public.is_super_admin(auth.uid()) 
    OR (
      public.has_role(auth.uid(), 'admin_sekolah')
      AND public.can_access_school(auth.uid(), school_id)
    )
  );

-- Operator: Bisa create dan edit own posts
CREATE POLICY "Operators can create posts"
  ON public.posts FOR INSERT
  TO authenticated
  WITH CHECK (
    public.has_role(auth.uid(), 'operator')
    AND public.can_access_school(auth.uid(), school_id)
    AND author_id = auth.uid()
  );

CREATE POLICY "Operators can update own posts"
  ON public.posts FOR UPDATE
  TO authenticated
  USING (
    public.has_role(auth.uid(), 'operator')
    AND author_id = auth.uid()
  );

CREATE POLICY "Operators can delete own posts"
  ON public.posts FOR DELETE
  TO authenticated
  USING (
    public.has_role(auth.uid(), 'operator')
    AND author_id = auth.uid()
  );
```

### 4.8 Gallery Policies
```sql
-- Public: Bisa lihat semua gallery
CREATE POLICY "Public can view gallery"
  ON public.gallery FOR SELECT
  USING (true);

-- School users: Full CRUD untuk sekolahnya
CREATE POLICY "School users can manage gallery"
  ON public.gallery FOR ALL
  TO authenticated
  USING (public.can_access_school(auth.uid(), school_id));
```

### 4.9 School Registrations Policies
```sql
-- Public: Bisa submit registrasi baru
CREATE POLICY "Anyone can submit registration"
  ON public.school_registrations FOR INSERT
  WITH CHECK (true);

-- Super Admin: Full access
CREATE POLICY "Super admin can manage registrations"
  ON public.school_registrations FOR ALL
  TO authenticated
  USING (public.is_super_admin(auth.uid()));
```

---

## Tahap 5: Triggers untuk Auto-update

### 5.1 Auto-update updated_at
```sql
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply to all tables with updated_at
CREATE TRIGGER set_updated_at_schools
  BEFORE UPDATE ON public.schools
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER set_updated_at_profiles
  BEFORE UPDATE ON public.profiles
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER set_updated_at_staff
  BEFORE UPDATE ON public.staff
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER set_updated_at_students
  BEFORE UPDATE ON public.students
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();

CREATE TRIGGER set_updated_at_posts
  BEFORE UPDATE ON public.posts
  FOR EACH ROW EXECUTE FUNCTION public.handle_updated_at();
```

### 5.2 Auto-create profile on signup
```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, name)
  VALUES (
    NEW.id, 
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'name', NEW.email)
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

---

## Tahap 6: Indexes untuk Performance

```sql
-- Schools
CREATE INDEX idx_schools_domain ON public.schools(domain);
CREATE INDEX idx_schools_level ON public.schools(level);
CREATE INDEX idx_schools_is_active ON public.schools(is_active);

-- Profiles
CREATE INDEX idx_profiles_school_id ON public.profiles(school_id);
CREATE INDEX idx_profiles_email ON public.profiles(email);

-- User Roles
CREATE INDEX idx_user_roles_user_id ON public.user_roles(user_id);
CREATE INDEX idx_user_roles_role ON public.user_roles(role);

-- Staff
CREATE INDEX idx_staff_school_id ON public.staff(school_id);
CREATE INDEX idx_staff_is_public ON public.staff(is_public);

-- Students
CREATE INDEX idx_students_school_id ON public.students(school_id);
CREATE INDEX idx_students_class ON public.students(class);

-- Posts
CREATE INDEX idx_posts_school_id ON public.posts(school_id);
CREATE INDEX idx_posts_status ON public.posts(status);
CREATE INDEX idx_posts_author_id ON public.posts(author_id);

-- Gallery
CREATE INDEX idx_gallery_school_id ON public.gallery(school_id);
CREATE INDEX idx_gallery_category ON public.gallery(category);
```

---

## Tahap 7: Storage Buckets

Setelah tables selesai, perlu membuat storage buckets untuk file uploads:

1. **staff-photos** - Untuk foto profil pegawai
2. **gallery-images** - Untuk galeri sekolah  
3. **post-images** - Untuk gambar berita/artikel
4. **school-assets** - Untuk logo dan hero images sekolah

---

## Diagram Entity Relationship

```
┌─────────────────┐     ┌─────────────────┐
│   auth.users    │     │    profiles     │
│ (Supabase Auth) │────▶│   (user info)   │
└────────┬────────┘     └────────┬────────┘
         │                       │
         │                       │ school_id
         ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│   user_roles    │     │     schools     │
│ (role terpisah) │     │ (data sekolah)  │
└─────────────────┘     └────────┬────────┘
                                 │
         ┌───────────┬───────────┼───────────┬───────────┐
         ▼           ▼           ▼           ▼           ▼
    ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
    │  staff  │ │students │ │  posts  │ │ gallery │ │ regist. │
    └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘
```

---

## Langkah Implementasi

1. **Migration 1**: Buat ENUMs dan helper functions
2. **Migration 2**: Buat core tables (schools, profiles, user_roles)
3. **Migration 3**: Buat data tables (staff, students, posts, gallery, registrations)
4. **Migration 4**: Enable RLS dan buat policies
5. **Migration 5**: Buat triggers dan indexes
6. **Migration 6**: Setup storage buckets
7. **Seed Data**: Migrate dummy data ke production

---

## Security Highlights

- Roles disimpan di tabel terpisah `user_roles` (sesuai requirement)
- Semua akses divalidasi server-side via RLS
- Super Admin memiliki akses penuh
- Admin Sekolah hanya bisa akses data sekolahnya
- Operator hanya bisa edit konten miliknya sendiri
- Data publik (website) tetap bisa diakses tanpa login
- Tidak ada pengecekan admin via localStorage

Jalankan Database Migration
Seed Dummy Data ke Production
Setup Storage Buckets